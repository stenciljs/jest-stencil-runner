name: Release Stencil Jest Runner

on:
  workflow_dispatch:
    inputs:
      releaseType:
        description: 'Release type - major, minor or patch'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      devRelease:
        description: Set to "yes" to release a dev build
        required: true
        type: choice
        default: 'no'
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  release-dev:
    if: inputs.devRelease == 'yes'
    name: Publish Dev Build
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: 'https://registry.npmjs.org'

      - name: Generate dev version
        id: version
        run: |
          PKG_VERSION=$(jq -r '.version' package.json)
          GIT_HASH=$(git rev-parse --short HEAD)
          DEV_VERSION="${PKG_VERSION}-dev.$(date +%s).${GIT_HASH}"
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing dev version: ${DEV_VERSION}"

      - name: Set dev version
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: npm publish --tag dev --provenance --access public

  release-prod:
    if: inputs.devRelease == 'no'
    name: Publish Production Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: 'https://registry.npmjs.org'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: version
        run: |
          npm version ${{ inputs.releaseType }} -m "v%s"
          echo "version=$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT

      - name: Push version commit and tag
        run: git push --follow-tags

      - name: Publish to npm
        run: npm publish --tag latest --provenance --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
